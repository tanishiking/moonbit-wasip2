# Hello moonbit via WASIp2

Not sure which files to gitignore...

It seems that the blog post [Developing Wasm Component Model in MoonBit with Minimal Output Size | MoonBit](https://www.moonbitlang.com/blog/component-model) is slightly outdated (as of November 27, 2024).

- The ecosystem is moving from `wit-deps` to `wkg` (maybe?).
- `wit-bindgen` for `moonbit` has been merged upstream.
- The structure generated by `wit-bindgen` has been updated.

This repo demonstrates running `hello` using WASI Preview2.

### Write your WIT

```sh
$ cat wit/world.wit
package tanishiking:hello-moon-wasip2@0.0.1;

world run {
    import wasi:cli/stdout@0.2.2;
    export wasi:cli/run@0.2.2;
}
```

Since `wit-bindgen-cli` defaults to reading WIT files from the `wit` directory, let’s place the WIT files there.

We can fetch the dependent WIT files using `wkg`.

```sh
❯ wkg wit --help
Commands for interacting with WIT files and dependencies

Usage: wkg wit <COMMAND>

Commands:
  ...
  fetch   Fetch dependencies for a component. This will read the package
          containing the world(s) you have defined in the given wit directory
          (`wit` by default). It will then fetch the dependencies and write
          them to the `deps` directory along with a lock file. If no lock file
          exists, it will fetch all dependencies. If a lock file exists, it
          will fetch any dependencies that are not in the lock file and update
          the lock file. To update the lock file, use the `update` command
```

```sh
$ wkg wit fetch

|-- wit
|   |-- deps
|   |   |-- wasi-cli-0.2.2
|   |   |   `-- package.wit
|   |   |-- wasi-clocks-0.2.2
|   |   |   `-- package.wit
|   |   |-- wasi-filesystem-0.2.2
|   |   |   `-- package.wit
|   |   |-- wasi-io-0.2.2
|   |   |   `-- package.wit
|   |   |-- wasi-random-0.2.2
|   |   |   `-- package.wit
|   |   `-- wasi-sockets-0.2.2
|   |       `-- package.wit
|   `-- world.wit
|-- wkg.lock
```

Generate bindings using `wit-bindgen-cli`.

```sh
$ wit-bindgen moonbit wit --derive-show --derive-eq --out-dir .
Generating "./ffi/moon.pkg.json"
Generating "./ffi/top.mbt"
Generating "./gen/ffi.mbt"
Generating "./gen/gen_interface_wasi_cli_run_export.mbt"
Generating "./gen/interface/wasi/cli/run/moon.pkg.json"
Generating "./gen/interface/wasi/cli/run/stub.mbt"
Generating "./gen/interface/wasi/cli/run/top.mbt"
...
```

It seems that the exported interfaces are now generated in `gen/interface/.../stub.mbt`.

```sh
$ cat gen/interface/wasi/cli/run/stub.mbt
// Generated by `wit-bindgen` 0.35.0.
/// Run the program.
pub fn run() -> Result[Unit, Unit] {
      abort("todo")
}

$ wasm-tools component embed wit target/wasm/release/build/gen/gen.wasm -o target/wasm/release/build/gen/gen.wasm --encoding utf16
$ wasm-tools component new target/wasm/release/build/gen/gen.wasm -o target/wasm/release/build/gen/gen.wasm

$ wasmtime target/wasm/release/build/gen/gen.wasm
Error: failed to run main module `target/wasm/release/build/gen/gen.wasm`

Caused by:
    0: failed to invoke `run` function
    1: error while executing at wasm backtrace:
           0:  0x7a4 - <unknown>!<wasm function 17>
           1:  0x8a2 - <unknown>!<wasm function 26>
           2:  0x8a9 - <unknown>!<wasm function 27>
    2: wasm trap: wasm `unreachable` instruction executed
```

Now, let's implement the `wasi:cli/run`.

Oops, `println` doesn't work.

```sh
$ cat gen/interface/wasi/cli/run/stub.mbt
// Generated by `wit-bindgen` 0.35.0.
/// Run the program.
pub fn run() -> Result[Unit, Unit] {
    println("hello")
    Ok(())
}

$ wasm-tools component new target/wasm/release/build/gen/gen.wasm -o target/wasm/release/build/gen/gen.wasm

error: failed to encode a component from module

Caused by:
    0: failed to decode world from module
    1: module was not valid
    2: module requires an import interface named `spectest`

$ wasm-tools print target/wasm/release/build/gen/gen.wasm
(module
  ;; ...
  (import "spectest" "print_char" (func (;0;) (type 0)))
  ;; ...
```

Use `get-stdout` and `blocking_write_and_flush` instead.

```sh
$ cat interface/wasi/cli/stdout/top.mbt
// Generated by `wit-bindgen` 0.35.0. DO NOT EDIT!

pub fn get_stdout() -> @streams.OutputStream {

      let result : Int =  wasmImportGetStdout();
      return @streams.OutputStream::OutputStream(result)

}

❯ cat interface/wasi/io/streams/top.mbt
// ...

pub fn OutputStream::blocking_write_and_flush(self : OutputStream, contents : Bytes) -> Result[Unit, StreamError] {
// ...
```

Import those packages to the module,

```sh
$ cat gen/interface/wasi/cli/run/moon.pkg.json
{
  "import": [
    {
      "path": "tanishiking/hello-moon-wasip2/interface/wasi/cli/stdout",
      "alias": "stdout"
    },
    {
      "path" : "tanishiking/hello-moon-wasip2/interface/wasi/io/streams",
      "alias" : "streams"
    }
  ]
}
```

```moon
// gen/interface/wasi/cli/run/stub.mbt
// Generated by `wit-bindgen` 0.35.0.
/// Run the program.
pub fn run() -> Result[Unit, Unit] {
    let stdout = @stdout.get_stdout()
    let hello : Bytes = b"hello"
    let _ = stdout.blocking_write_and_flush(hello)
    Ok(())
}
```

build and run

```sh
$ moon build --target wasm
# Not sure why this is needed
$ wasm-tools component embed wit target/wasm/release/build/gen/gen.wasm -o target/wasm/release/build/gen/gen.wasm --encoding utf16

$ wasm-tools component new target/wasm/release/build/gen/gen.wasm -o target/wasm/release/build/gen/gen.wasm

$ wasmtime target/wasm/release/build/gen/gen.wasm
hello%
```
